window.STRICT_INVITE_CHECK=!1,angular.module("roster-io",["ui.router","ngMaterial","firebaseHelper"]).config(["$urlRouterProvider","$stateProvider","$firebaseHelperProvider","$sceProvider",function(e,t,n,o){e.when("","/"),e.when("/","/rosters"),t.state("rosters",{url:"/rosters",templateUrl:"views/page/rosters.html",controller:["$rootScope","$firebaseHelper",function(e,t){e.rosters=t.array("rosters"),e.roster=e.event=void 0}]}).state("roster",{url:"/roster/:roster",templateUrl:"views/page/roster.html",controller:["$rootScope","$firebaseHelper","$stateParams",function(e,t,n){e.roster=t.object("rosters",n.roster),e.event=void 0}]}).state("event",{url:"/roster/:roster/:event",templateUrl:"views/page/event.html",controller:["$rootScope","$firebaseHelper","$stateParams",function(e,t,n){e.roster=t.object("rosters",n.roster),e.event=t.object(e.roster,"events",n.event)}]}).state("invite",{url:"/invite/:invite",templateUrl:"views/page/invite.html",controller:["$rootScope","$firebaseHelper","$stateParams","$q",function(e,t,n,o){e.invite=t.object("invites",n.invite),e.invite.$loaded().then(function(n){null!==n.$value?(e.roster=t.object("rosters",n.to.params.roster),e.inviter=t.object("users",n.by),o.all([e.roster.$loaded(),e.inviter.$loaded()]).then(function(){e.invite.$$loaded=!0})):e.notFound=!0})}]}),n.namespace("roster-io"),o.enabled(!1)}]).factory("Auth",["$firebaseHelper",function(e){return e.auth()}]).controller("AppCtrl",["$rootScope","$state","$firebaseHelper","Auth",function(e,t,n,o){e.$state=t,e.$firebaseHelper=n,e.console=console,e.$on("$stateChangeSuccess",function(e,n,o,r,i){t.$previous=r,t.$previous.params=i});var r=function(){};e.$me={},e.$unauth=o.$unauth,o.$onAuth(function(t){t?(e.$me=n.object("users/"+t.uid),e.$me.$ref().update(t),r()):e.$me={}}),e.$authThen=function(e){var t=o.$getAuth();t?angular.isFunction(e)&&e(t):o["$authWithOAuth"+(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?"Redirect":"Popup")]("facebook",{scope:"email"}).then(function(t){angular.isFunction(e)&&e(t)}).catch(function(e){console.error(e)})},e.canEdit=function(t,n){return angular.isArray(n)&&n.indexOf(e.$me.uid)>=0?!0:angular.isObject(n)&&n[e.$me.uid]?!0:t?t===e.$me.uid:e.$me.admin},e.avatar=function(e){return"//graph.facebook.com/"+(e?e+"/":"")+"picture?type=square"}}]).controller("RostersCtrl",["$scope","$firebaseHelper","$mdDialogForm","$mdToast",function(e,t,n,o){e.threads=[],e.loadThreads=function(){e.$authThen(function(t){FB.api("/me/threads","get",{access_token:t.facebook.accessToken},function(t){return t.error?console.error(t):(e.$apply(function(){e.threads=t.data}),void 0)})})},e.importParticipants=function(n){var o={};angular.forEach(n.participants.data,function(e){o["facebook:"+e.id]={id:e.id,name:e.name}});var r={};r[e.$me.uid]=e.$me.uid,t.array("rosters").$add({admins:r,thread:n.id,participants:o})},e.newRoster=function(){e.roster={},n.show({scope:e,title:"Add new roster",contentUrl:"views/template/roster.html",ok:"Create",onSubmit:function(t){return this.loading=!0,e.rosters.$add(t.roster).then(function(){this.loading=!1,o.showSimple({content:"Roster created."})})}})}}]).controller("RosterCtrl",["$scope","$firebaseHelper","$mdDialogForm","$state","$mdToast",function(e,t,n,o,r){e.invitees=t.object(e.roster,"invites"),e.invites=t.join([e.roster,"invites"],"invites"),e.participants=t.join([e.roster,"participants"],"users"),e.events=t.array(e.roster,"events"),e.users=t.array("users"),e.deleteRoster=function(t){(t||confirm("Are you sure you want to permanently delete this roster?"))&&e.roster.$remove().then(function(){o.go("rosters"),r.showSimple({content:"Roster deleted."})})},e.editRoster=function(){n.show({scope:e,title:"Edit roster",contentUrl:"views/template/roster.html",ok:"Save",onSubmit:function(){return this.loading=!0,e.roster.$save().then(function(){this.loading=!1,r.showSimple({content:"Roster saved."})})}})},e.newEvent=function(){e.event={},n.show({scope:e,title:"Add new event",contentUrl:"views/template/event.html",ok:"Create",onSubmit:function(t){return this.loading=!0,t.event.date=moment(t.event.$date).format(),e.events.$add(t.event).then(function(){this.loading=!1,r.showSimple({content:"Event created."})})}})},e.inviteUser=function(i){e.invite={by:e.$me.uid,to:{name:o.current.name,params:o.params},name:(i||"").replace(/\b\w+/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1)})},n.show({scope:e,title:"Invite new user",contentUrl:"views/template/invite.html",ok:"Invite",onSubmit:function(n){return this.loading=!0,t.array("invites").$add(e.invite).then(function(t){var o=t.key();e.invitees[o]=o,e.invitees.$save().then(function(){this.loading=!1,r.showSimple({content:'Invitation email sent to "'+n.invite.name+" <"+n.invite.email+'>".'})})})}})},e.removeUser=function(t,n,o){if(o=o||e.participants,t||confirm("Are you sure you want to remove this user from this roster?")){var i=n.name;o.$unlink(n).then(function(){r.showSimple({content:'"'+i+'" removed.'})})}}}]).controller("EventCtrl",["$scope","$firebaseHelper","$mdDialogForm","$state","$mdToast",function(e,t,n,o,r){e.urlencode=window.encodeURIComponent,e.participants=t.join([e.roster,"participants"],"users"),e.rsvps=t.object(e.event,"rsvps"),e.statuses=t.array("statuses"),e.rsvp=function(n,o){return t.object(e.event,"rsvps",n).$loaded().then(function(e){return e.status=e.status===o?-2:o,e.updated=moment().format(),e.$save()})},e.deleteEvent=function(t){(t||confirm("Are you sure you want to permanently delete this event?"))&&e.event.$remove().then(function(){o.go("roster",{roster:e.roster.$id}),r.showSimple({content:"Event deleted."})})},e.editEvent=function(){e.event.$date=moment(e.event.date).toDate(),n.show({scope:e,title:"Edit event",contentUrl:"views/template/event.html",ok:"Save",onSubmit:function(t){return this.loading=!0,t.event.date=moment(t.event.$date).format(),e.event.$save().then(function(){this.loading=!1,r.showSimple({content:"Event saved."})})}})}}]).controller("InviteCtrl",["$scope","$firebaseHelper","Auth","$state","$mdToast","$mdDialog",function(e,t,n,o,r,i){e.acceptInvite=function(){e.$authThen()},n.$onAuth(function(t){e.invite.$loaded().then(function(n){return n.accepted?(r.showSimple({content:"Invitation already accepted."}),o.go(n.to.name,n.to.params)):(t&&(e.notFound||e.$me.$loaded().then(function(t){STRICT_INVITE_CHECK&&n.email===t.email||!STRICT_INVITE_CHECK?e.roster.$loaded().then(function(){var i={};i[n.to.params.roster]=n.to.params.roster,e.$me.$ref().update({name:n.name,email:n.email,gender:n.gender,rosters:i}),e.roster.invites&&delete e.roster.invites[n.$id],e.roster.participants||(e.roster.participants={}),e.roster.participants[t.uid]=t.uid,e.roster.$save().then(function(){e.invite.accepted=moment().format(),e.invite.$save().then(function(){return r.showSimple({content:"Invitation accepted."}),o.go(n.to.name,n.to.params)})})}):i.show(i.alert({content:"Sorry, your Facebook email ("+t.email+") does not match the email this invite was sent to ("+n.email+").",ok:"OK"}))})),void 0)})})}]).filter("filterByRsvp",function(){return function(e,t,n){return angular.isArray(e)&&angular.isObject(t)?(n=parseInt(n),e.filter(function(e){return t[e.$id]?t[e.$id].status===n:-2===n})):e}}).filter("gender",function(){return function(e,t){return angular.isArray(e)&&angular.isString(t)?e.filter(function(e){return e.gender===t}):e}}).filter("length",function(){return function(e){return angular.isArray(e)?e.length:0}}).factory("$mdDialogForm",["$mdDialog","$q",function(e,t){return{show:function(n){return e.show(e.confirm(angular.extend({focusOnOpen:!1,preserveScope:!0,ok:"Submit",cancel:"Cancel",template:['<md-dialog ng-form="dialogForm" md-theme="{{ dialog.theme }}" aria-label="{{ dialog.ariaLabel }}" ng-class="{loading: dialog.loading}">','<md-dialog-content role="document" tabIndex="-1">','<h2 class="md-title">{{ dialog.title }}</h2>','<p ng-if="dialog.content">{{ dialog.content }}</p>','<div ng-if="dialog.contentUrl" ng-include="dialog.contentUrl"></div>',"</md-dialog-content>",'<div class="md-actions">','<md-button ng-if="dialog.$type == \'confirm\'" ng-click="dialog.abort()" class="md-primary">',"{{ dialog.cancel }}","</md-button>",'<md-button type="submit" ng-disabled="dialogForm.$invalid || dialog.loading" ng-click="dialog.onSubmit(this).then(dialog.hide)" class="md-primary">',"{{ dialog.ok }}","</md-button>","</div>","<md-dialog-footer>",'<md-progress-circular md-mode="indeterminate"></md-progress-circular>',"</md-dialog-footer>","</md-dialog>"].join(""),onSubmit:function(e){var n=t.defer();return this.loading=!0,e.dialogForm.$valid?(this.loading=!1,n.resolve()):(this.loading=!1,n.reject()),n.promise}},n||{})))}}}]);