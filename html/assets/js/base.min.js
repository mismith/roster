window.STRICT_INVITE_CHECK=!1,angular.module("roster-io",["ui.router","ngMaterial","firebaseHelper","ngTouch"]).config(["$urlRouterProvider","$stateProvider","$firebaseHelperProvider","$sceProvider",function(e,t,r,n){e.when("","/"),e.when("/","/rosters"),t.state("rosters",{url:"/rosters",templateUrl:"views/page/rosters.html",resolve:{currentAuth:["Auth",function(e){return e.$waitForMe()}]},controller:"RostersCtrl"}).state("roster",{url:"/roster/:roster",templateUrl:"views/page/roster.html",controller:"RosterCtrl"}).state("event",{url:"/roster/:roster/:event?v",templateUrl:"views/page/event.html",controller:"EventCtrl"}).state("invite",{url:"/invite/:invite",templateUrl:"views/page/invite.html",controller:"InviteCtrl"}).state("user",{url:"/user/:user",templateUrl:"views/page/user.html",controller:"UserCtrl"}),r.namespace("roster-io"),n.enabled(!1)}]).factory("Auth",["$rootScope","$firebaseHelper","$q",function(e,t,r){var n=t.auth();return e.$me={},n.$onAuth(function(r){r?(e.$me=t.object("data/users/"+r.uid),r.lastActive=moment().format(),e.$me.$ref().update(r)):e.$me={}}),n.$waitForMe=function(){var e=r.defer();return n.$waitForAuth().then(function(r){r?t.object("data/users/"+r.uid).$loaded().then(function(t){r.$me=t,e.resolve(r)}):e.resolve(r)}),e.promise},e.$unauth=n.$unauth,n}]).controller("AppCtrl",["$rootScope","$state","$firebaseHelper","Auth",function(e,t,r,n){e.$state=t,e.$firebaseHelper=r,e.console=console,e.$on("$stateChangeSuccess",function(e,r,n,i,o){t.$previous=i,t.$previous.params=o}),e.$authThen=function(e){var t=n.$getAuth();t?angular.isFunction(e)&&e(t):n["$authWithOAuth"+(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?"Redirect":"Popup")]("facebook",{scope:"email"}).then(function(t){angular.isFunction(e)&&e(t)}).catch(function(e){console.error(e)})},e.canEdit=function(){var t=Array.prototype.slice.call(arguments);return!!t.filter(function(t){return angular.isArray(t)&&t.indexOf(e.$me.$id)>=0?!0:angular.isObject(t)&&t[e.$me.$id]?!0:t?t===e.$me.$id:!1}).length||e.$me.admin},e.avatar=function(e){return"//graph.facebook.com/"+(e?e+"/":"")+"picture?type=square"}}]).controller("RostersCtrl",["$scope","$rootScope","$firebaseHelper","$q","Auth","$mdDialogForm","$mdToast",function(e,t,r,n,i,o,a){i.$onAuth(function(t){t&&(e.rosters=r.join([e.$me,"rosters"],"data/rosters"))}),t.roster=t.event=null,e.newRoster=function(){e.roster={admins:{},participants:{}},o.show({scope:e,title:"Add new roster",contentUrl:"views/template/roster.html",ok:"Create",onSubmit:function(t){return e.rosters.$add(t.roster).then(function(t){n.all([r.join([t,"admins"],"data/users").$link(e.$me.$id),r.join([t,"participants"],"data/users").$link(e.$me.$id),r.join([e.$me,"rosters"],"data/rosters").$link(t.key())]).then(function(){a.showSimple({content:"Roster created."})})})}})},e.initials=function(e){return(e||"").split(" ").map(function(e){return e?e[0].toUpperCase():""}).join("")}}]).controller("RosterCtrl",["$scope","$rootScope","$firebaseHelper","$mdDialogForm","$state","$mdToast","$q","Api","RSVP",function(e,t,r,n,i,o,a,s,l){e.timegroups=r.array("constants/timegroups"),t.roster=r.object("data/rosters",i.params.roster),t.event=null,e.invites=r.join([e.roster,"invites"],"data/invites"),e.participants=r.join([e.roster,"participants"],"data/users"),e.events=r.array(e.roster,"events"),e.users=r.array("data/users"),e.RSVP=l,e.deleteRoster=function(t){if(t||confirm("Are you sure you want to permanently delete this roster?")){var n=[],s=e.roster.$id,l=function(e){n.push(r.object("data/users",e,"rosters",s).$remove())};angular.forEach(e.roster.admins,l),angular.forEach(e.roster.participants,l),n.push(e.roster.$remove()),a.all(n).then(function(){i.go("rosters"),o.showSimple({content:"Roster deleted."})})}},e.editRoster=function(){n.show({scope:e,title:"Edit roster",contentUrl:"views/template/roster.html",ok:"Save",onSubmit:function(){return e.roster.$save().then(function(){o.showSimple({content:"Roster saved."})})}})},e.newEvent=function(){e.event={},n.show({scope:e,title:"Add new event",contentUrl:"views/template/event.html",ok:"Create",onSubmit:function(t){return t.event.date=moment(t.event.$date).format(),e.events.$add(t.event).then(function(){o.showSimple({content:"Event created."})})}})},e.removeUser=function(t,r,n){if(n=n||e.participants,t||confirm("Are you sure you want to remove this user from this roster?")){var i=r.name;n.$unlink(r).then(function(){o.showSimple({content:'"'+i+'" removed.'})})}},e.inviteUser=function(){e.invite={by:e.$me.$id,to:{name:i.current.name,params:i.params}},e.loadExistingUser=function(t){e.invite.email=t.email},n.show({scope:e,title:"Invite new user",contentUrl:"views/template/invite.html",ok:"Invite",onSubmit:function(t){a.defer();angular.forEach(e.users,function(t){t.email===e.invite.email&&console.log(t)})}})},e.rescindInvite=function(t,r,n){if(n=n||e.invites,t||confirm("Are you sure you want to rescind this user's invite?")){var i=r.name||r.email;n.$remove(r).then(function(){o.showSimple({content:'Invite for "'+i+'" rescinded.'})})}}}]).controller("EventCtrl",["$scope","$rootScope","$firebaseHelper","$mdDialogForm","$state","$mdToast","Auth","RSVP","$location",function(e,t,r,n,i,o,a,s,l){t.roster=r.object("data/rosters",i.params.roster),t.event=r.object(e.roster,"events",i.params.event),void 0!==i.params.v&&a.$onAuth(function(t){t&&s(e.event).setParticipantStatus(t.uid,i.params.v).then(function(){l.url(l.path())})}),e.statuses=r.array("constants/statuses"),e.participants=r.join([e.roster,"participants"],"data/users"),e.RSVP=s,e.urlencode=window.encodeURIComponent,e.deleteEvent=function(t){(t||confirm("Are you sure you want to permanently delete this event?"))&&e.event.$remove().then(function(){i.go("roster",{roster:e.roster.$id}),o.showSimple({content:"Event deleted."})})},e.editEvent=function(){e.event.$date=moment(e.event.date).toDate(),n.show({scope:e,title:"Edit event",contentUrl:"views/template/event.html",ok:"Save",onSubmit:function(t){return t.event.date=moment(t.event.$date).format(),e.event.$save().then(function(){o.showSimple({content:"Event saved."})})}})},e.cloneEvent=function(){var t={};return angular.forEach(e.event,function(e,r){t[r]=e}),r.array(e.roster,"events").$add(t).then(function(t){i.go("event",{roster:e.roster.$id,event:t.key()}),o.showSimple({content:"Event cloned."})})}}]).controller("InviteCtrl",["$rootScope","$scope","$firebaseHelper","$state","$q","Auth","$mdToast","$mdDialog",function(e,t,r,n,i,o,a,s){e.roster=e.event=null,t.invite=r.object("data/invites",n.params.invite),t.invite.$loaded().then(function(e){null!==e.$value?(t.roster=r.object("data/rosters",e.to.params.roster),t.inviter=r.object("data/users",e.by),i.all([t.roster.$loaded(),t.inviter.$loaded()]).then(function(){t.invite.$$loaded=!0})):t.notFound=!0}),t.acceptInvite=function(){t.$authThen()},o.$onAuth(function(e){t.invite.$loaded().then(function(r){return r.accepted?(a.showSimple({content:"Invitation already accepted."}),n.go(r.to.name,r.to.params)):(e&&(t.notFound||t.$me.$loaded().then(function(e){STRICT_INVITE_CHECK&&r.email===e.email||!STRICT_INVITE_CHECK?t.roster.$loaded().then(function(){var i={};i[r.to.params.roster]=r.to.params.roster,t.$me.$ref().update({email:r.email||e.facebook.email,name:r.name||e.facebook.displayName,gender:e.facebook.gender||"male",rosters:i}),t.roster.invites&&delete t.roster.invites[r.$id],t.roster.participants||(t.roster.participants={}),t.roster.participants[e.uid]=e.uid,t.roster.$save().then(function(){t.invite.accepted=moment().format(),t.invite.$save().then(function(){return a.showSimple({content:"Invitation accepted."}),n.go(r.to.name,r.to.params)})})}):s.show(s.alert({content:"Sorry, your Facebook email ("+e.email+") does not match the email this invite was sent to ("+r.email+").",ok:"OK"}))})),void 0)})})}]).controller("UserCtrl",["$rootScope","$scope","$firebaseHelper","$state","$mdToast","$mdDialogForm",function(e,t,r,n,i,o){e.roster=e.event=null,t.user=r.object("data/users",n.params.user),t.rosters=r.join([t.user,"rosters"],"data/rosters"),t.editUser=function(){o.show({scope:t,title:"Edit user",contentUrl:"views/template/user.html",ok:"Save",onSubmit:function(){return t.user.$save().then(function(){i.showSimple({content:"User saved."})})}})}}]).factory("RSVP",["$firebaseHelper","$q","$mdToast",function(e,t,r){return function(n,i){i=angular.extend({showToast:!0},i);var o=e.object("constants/statuses"),a=e.object(n,"rsvps");return{statuses:o,rsvps:a,getParticipantStatus:function(e){return a&&a[e]?a[e].status:-2},setParticipantStatus:function(n,s){s=parseInt(s);var l=t.defer();return e.object(a,n).$loaded().then(function(e){return e.status=s,e.updated=moment().format(),e.$save().then(function(){l.resolve(),i.showToast&&o.$loaded().then(function(){r.showSimple({content:'Your RSVP saved as: "'+o[e.status].name+'"'})})})})}}}}]).directive("rsvp",function(){return{scope:{event:"=",participant:"=",readonly:"="},restrict:"E",templateUrl:"views/directive/rsvp.html",controller:["$scope","RSVP",function(e,t){e.RSVP=t}]}}).filter("filterByRsvp",function(){return function(e,t,r){return angular.isArray(e)?(angular.isObject(t)||(t={}),r=parseInt(r),e.filter(function(e){if(!t[e.$id])return-2===r;switch(t[e.$id].status){case 1:case 0:case-1:return r===t[e.$id].status;default:return-2===r}})):e}}).filter("filterByTimegroup",function(){return function(e,t){return angular.isArray(e)?e.filter(function(e){return(moment().diff(e.date)<0?"upcoming":"past")===t}):e}}).filter("gender",function(){return function(e,t){return angular.isArray(e)&&angular.isString(t)?e.filter(function(e){return e.gender===t}):e}}).filter("length",function(){return function(e){return angular.isArray(e)?e.length:angular.isObject(e)?Object.keys(e).length:0}}).factory("$mdDialogForm",["$mdDialog","$q",function(e,t){return{show:function(r){return e.show(e.confirm(angular.extend({focusOnOpen:!1,preserveScope:!0,ok:"Submit",cancel:"Cancel",template:['<md-dialog ng-form="dialogForm" md-theme="{{ dialog.theme }}" aria-label="{{ dialog.ariaLabel }}" ng-class="{loading: dialog.loading}">','<md-dialog-content role="document" tabIndex="-1">','<h2 class="md-title">{{ dialog.title }}</h2>','<p ng-if="dialog.content">{{ dialog.content }}</p>','<div ng-if="dialog.contentUrl" ng-include="dialog.contentUrl"></div>',"</md-dialog-content>",'<div class="md-actions">','<md-button ng-if="dialog.$type == \'confirm\'" ng-click="dialog.abort()" class="md-primary">',"{{ dialog.cancel }}","</md-button>",'<md-button type="submit" ng-disabled="dialogForm.$invalid || dialog.loading" ng-click="dialog.startLoading(); dialog.onSubmit(this).then(dialog.hide).finally(dialog.stopLoading)" class="md-primary">',"{{ dialog.ok }}","</md-button>","</div>","<md-dialog-footer>",'<md-progress-circular md-mode="indeterminate"></md-progress-circular>',"</md-dialog-footer>","</md-dialog>"].join(""),startLoading:function(){this.loading=!0},stopLoading:function(){this.loading=!1},onSubmit:function(){var e=t.defer();return e.resolve(),e.promise}},r||{})))}}}]).factory("Api",["$http","$q",function(e,t){var r="/api/v1/";return{post:function(n,i,o){var a=t.defer();return e.post(r+n.replace(/^\/+/,""),i,o).success(function(e){e&&e.success?a.resolve(e):a.reject(e)}).error(function(e,t){a.reject({code:t,message:e})}),a.promise}}}]).directive("loading",function(){return{restrict:"E",replace:!0,template:['<div flex layout="column" layout-align="center center">','<md-progress-circular md-mode="indeterminate"></md-progress-circular>',"</div>"].join("")}}).directive("mdSwipeItem",["$swipe","$timeout","$parse",function(e,t,r){return{restrict:"A",link:function(n,i,o){i.addClass("md-swipe-item");var a=angular.element(i.children()[0]),s=angular.element(i.children()[1]);$left=angular.element(s.children()[0]),$right=angular.element(s.children()[1]);var l={left:0,right:0},c={left:!1,right:!1},d=!1,u=!1,m="ontouchend"in document,f=function(e){e===!0&&(e=0,c.left=c.right=!1,i.removeClass("md-swiping-left md-swiping-left-triggered md-swiping-right md-swiping-right-triggered"));var r="translate3d("+(e||0)+"px, 0, 0)";a.css({transform:r,webkitTransform:r}),i.addClass("md-swipe-item-animating"),t(function(){i.removeClass("md-swipe-item-animating"),c.leftMost&&i.removeClass("md-swiping-left-most-triggered"),c.rightMost&&i.removeClass("md-swiping-right-most-triggered"),c.left||i.removeClass("md-swiping-left md-swiping-left-triggered"),c.right||i.removeClass("md-swiping-right md-swiping-right-triggered")},100)},g=function(){return f(!0)},p=function(e,t){return"undefined"!=typeof getComputedStyle?getComputedStyle(e,null).getPropertyValue(t):e.currentStyle[t]};s.on("click",function(){g()}),e.bind(a,{start:function(e){u=e},move:function(e){if(d=!0,u&&m&&r(o.mdSwipeItem)(n)){var t=e.x-u.x,f="translate3d("+t+"px, 0, 0)";if(a.css({transform:f,webkitTransform:f}),0>t){i.addClass("md-swiping-left"),i.removeClass("md-swiping-right md-swiping-right-triggered"),c.right=!1;var g=$right.children();firstChild=g[0],l.right=s[0].offsetWidth-firstChild.offsetLeft+parseInt(p(firstChild,"margin-left")),-72>t?(i.addClass("md-swiping-left-triggered"),c.left=!0):(i.removeClass("md-swiping-left-triggered"),c.left=!1),angular.forEach($right.children(),function(e){var r=angular.element(e),n=e.clientWidth,i=$right[0].offsetWidth-e.offsetLeft-n,o="scale("+Math.max(0,Math.min((Math.abs(t)-i)/n,1))+")";r.css({transform:o,webkitTransform:o})}),t<.66*-s[0].offsetWidth?(i.addClass("md-swiping-left-most-triggered"),c.leftMost=!0):(i.removeClass("md-swiping-left-most-triggered"),c.leftMost=!1)}else{i.addClass("md-swiping-right"),i.removeClass("md-swiping-left md-swiping-left-triggered"),c.left=!1;var g=$left.children(),h=g[g.length-1];l.left=h.offsetLeft+h.offsetWidth+parseInt(p(h,"margin-right")),t>72?(i.addClass("md-swiping-right-triggered"),c.right=!0):(i.removeClass("md-swiping-right-triggered"),c.right=!1),angular.forEach($left.children(),function(e){var r=angular.element(e),n=e.clientWidth,i=($left[0].offsetWidth-e.offsetLeft-n,"scale("+Math.max(0,Math.min((Math.abs(t)-e.offsetLeft)/n,1))+")");r.css({transform:i,webkitTransform:i})}),t>.66*s[0].offsetWidth?(i.addClass("md-swiping-right-most-triggered"),c.rightMost=!0):(i.removeClass("md-swiping-right-most-triggered"),c.rightMost=!1)}}},end:function(){if(d){d=!1;var e="scale(1)";angular.forEach([$left.children(),$right.children()],function(t){angular.forEach(t,function(t){angular.element(t).css({transform:e,webkitTransform:e})})}),c.leftMost?r(o.mdSwipeLeftMostTriggered)(n):c.left?(r(o.mdSwipeLeftTriggered)(n),f(-l.right)):c.rightMost?r(o.mdSwipeRightMostTriggered)(n):c.right?r(o.mdSwipeRightTriggered)(n):g()}else g()},cancel:function(){d=!1,g()}}),n.mdSwipeItem={triggered:c,close:g,teaseLeft:function(){i.addClass("md-teasing-left"),t(function(){i.removeClass("md-teasing-left")},450)}}}}}]);