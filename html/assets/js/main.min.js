"use strict";angular.module("roster-io",["ngOpbeat","ui.router","ui.router.title","ngMaterial","firebaseHelper","ngTouch"]).config(["$opbeatProvider","$locationProvider","$urlRouterProvider","$urlMatcherFactoryProvider","$stateProvider","$firebaseHelperProvider","$sceProvider","$compileProvider",function(e,t,r,n,i,o,a,s){e.config({orgId:"6b3a8bba7de440a9905bf3ddf30b8c7e",appId:"110a8e5771"}),t.html5Mode(!0).hashPrefix("!"),r.when("","/"),n.strictMode(!1),i.state("home",{url:"/",templateUrl:"views/page/home.html",resolve:{authed:["Auth","$state",function(e,t){return e.$waitForMe().then(function(e){e.$id&&t.go("user",{user:e.$id})})}]}}).state("roster",{url:"/roster/:roster",templateUrl:"views/page/roster.html",controller:"RosterCtrl",resolve:{Roster:["$firebaseHelper","$stateParams","$state",function(e,t,r){return e.object("data/rosters",t.roster).$loaded(function(e){return null===e.$value?r.go("404",{model:"roster"},{location:!1}):e})}],$title:["Roster",function(e){return e.name}]}}).state("event",{url:"/roster/:roster/:event?v&edit",templateUrl:"views/page/event.html",controller:"EventCtrl",resolve:{Roster:["$firebaseHelper","$stateParams","$state",function(e,t,r){return e.object("data/rosters",t.roster).$loaded(function(e){return null===e.$value?r.go("404",{model:"roster"},{location:!1}):e})}],Event:["$firebaseHelper","$stateParams","$state","Roster",function(e,t,r,n){return e.object("data/rosters:events",n.$id,t.event).$loaded(function(e){return null===e.$value?r.go("404",{model:"event"},{location:!1}):e})}],$title:["Roster","Event",function(e,t){return t.name+" â€¢ "+e.name}]}}).state("invite",{url:"/invite/:invite",templateUrl:"views/page/invite.html",controller:"InviteCtrl",resolve:{Invite:["$firebaseHelper","$stateParams","$state",function(e,t,r){return e.object("data/invites",t.invite).$loaded(function(e){return null===e.$value?r.go("404",{model:"invite"},{location:!1}):e})}],Inviter:["$firebaseHelper","$stateParams","Invite",function(e,t,r){return e.object("data/users",r.inviterId).$loaded()}],Roster:["$firebaseHelper","$stateParams","Invite",function(e,t,r){return e.object("data/rosters",r.rosterId).$loaded()}],$title:function(){return"Invitation"}}}).state("user",{url:"/user/:user",templateUrl:"views/page/user.html",controller:"UserCtrl",resolve:{User:["$firebaseHelper","$stateParams","$state",function(e,t,r){return e.object("data/users",t.user).$loaded(function(e){return null===e.$value?r.go("404",{model:"user"},{location:!1}):e})}],$title:["User",function(e){return e.name}]}}).state("404",{templateUrl:"views/page/404.html",params:{model:"page"},controller:["$scope","$stateParams",function(e,t){e.model=t.model}]}),r.otherwise(function(e,t){var r=e.get("$state");return r.go("404",null,{location:!1}),t.path()}),o.namespace("roster-io"),a.enabled(!1),s.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|tel|webcal|fb\-messenger|(comgoogle)?maps(url)?):/)}]).factory("Auth",["$rootScope","$firebaseHelper","$state","$q","$timeout",function(e,t,r,n,i){var o=t.auth();return e.$me={},o.$onAuth(function(n){if(n){var i=t.ref("data/users/"+n.uid);e.$me=t.object(i),t.ref(".info/connected").on("value",function(e){e.val()&&(i.child("online").onDisconnect().set(moment().format()),i.child("online").set(!0))}),n.facebook&&e.$me.$loaded(function(e){e.facebookId=e.facebookId||n.facebook.id,e.name=e.name||n.facebook.displayName,e.email=e.email||n.facebook.email,e.gender=e.gender||n.facebook.cachedUserProfile?n.facebook.cachedUserProfile.gender:null,e.$save()}),"home"===r.current.name&&r.reload()}else e.$me={}}),o.$waitForMe=function(){var t=n.defer();return o.$waitForAuth().then(function(r){i(function(){t.resolve(e.$me)})}),t.promise},e.$auth=o.$auth=function(){return n.when(o.$getAuth()||o["$authWithOAuth"+(e.isMobile?"Redirect":"Popup")]("facebook",{scope:"email"}))},e.$unauth=o.$unauth,o}]).controller("AppCtrl",["$rootScope","$state","$firebaseHelper","Auth",function(e,t,r,n){e.loaded=!0,e.$state=t,e.$firebaseHelper=r,e.console=console,e.history=history,e.$on("$stateChangeSuccess",function(e,r,n,i,o){t.$previous=i,t.$previous.params=o}),e.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),e.isAndroid=/Android/i.test(navigator.userAgent),e.isiOS=/iPhone|iPad|iPod/i.test(navigator.userAgent),n.$onAuth(function(t){e.myRosters=t?r.join([e.$me,"rosters"],"data/rosters"):null}),e.canEdit=function(){var t=Array.prototype.slice.call(arguments);return!!t.filter(function(t){return angular.isArray(t)&&t.indexOf(e.$me.$id)>=0?!0:angular.isObject(t)&&t[e.$me.$id]?!0:t?t===e.$me.$id:!1}).length||e.$me.admin},e.avatar=function(e,t){t=t||"type=square";var r=e?e.facebookId:!1;return"//graph.facebook.com/"+(r?r+"/":"")+"picture?"+t},e.mapsUrl=function(t){var r=e.isiOS?"comgooglemapsurl":e.isMobile&&!e.isAndroid?"maps":"http",n="";return t.locationUrl?n=t.locationUrl.replace(/^https?:\/\//,""):t.location&&(n="maps.google.com/?q="+encodeURIComponent(t.location.replace("\n"," "))),r+"://"+n}}]).controller("RosterCtrl",["$scope","$rootScope","$firebaseHelper","$mdDialogForm","$state","$mdToast","$q","RSVP","$http","Roster",function(e,t,r,n,i,o,a,s,l,d){e.roster=d,e.timegroups=r.array("constants/timegroups"),e.events=r.array("data","rosters:events",d.$id),e.participants=r.join([d,"participants"],"data/users"),e.invites=r.join([d,"invites"],"data/invites"),e.users=r.array("data/users"),e.RSVP=s,e.deleteRoster=function(e){if(e||confirm("Are you sure you want to permanently delete this roster?")){var t=[],n=d.$id,s=function(e){t.push(r.object("data/users",e,"rosters",n).$remove())};angular.forEach(d.admins,s),angular.forEach(d.participants,s),t.push(d.$remove()),a.all(t).then(function(){i.go("home"),o.showSimple("Roster deleted.")})}},e.editRoster=function(){n.show({scope:e,title:"Edit roster",contentUrl:"views/template/roster.html",ok:"Save",onSubmit:function(){return d.$save().then(function(){o.showSimple("Roster saved.")})}})},e.newEvent=function(){e.event={},n.show({scope:e,title:"Add new event",contentUrl:"views/template/event.html",ok:"Create",onSubmit:function(t){return t.event.date=moment(t.event.$date).format(),e.events.$add(t.event).then(function(){o.showSimple("Event created.")})}})},e.removeUser=function(t,n,i){if(i=i||e.participants,t||confirm("Are you sure you want to remove this user from this roster?")){var s=n.name;a.all([i.$unlink(n),r.object("data/users",n.$id,"rosters",d.$id).$remove()]).then(function(){o.showSimple('"'+s+'" removed.')})}};var c=function(e){var t=a.defer(),n=r.ref("data/invites",e);return n.once("value",function(n){var i=n.val();r.array("queues/email").$add({template:"invite",data:{inviteId:e}}).then(function(){r.object(d,"invites").$loaded().then(function(r){r[e]=e,r.$save().then(function(){t.resolve(),o.showSimple('Invitation email sent to "'+(i.name?i.name+" ":"")+"<"+i.email+'>".')})["catch"](function(e){t.reject(e)})})["catch"](function(e){t.reject(e)})})["catch"](function(e){t.reject(e),o.showSimple("Error "+e.code+": "+e.message+".")})}),t.promise};e.inviteUser=function(){e.invite={inviterId:e.$me.$id,rosterId:d.$id},e.loadExistingUser=function(t){t=t||{},e.invite.name=t.name,e.invite.email=t.email},e.importGoogleContacts=function(){e.contacts=[],gapi.auth.authorize({client_id:"413081268225-vj2fi4to1uhlv6h7acdsn0l6kifjep21.apps.googleusercontent.com",scope:"https://www.googleapis.com/auth/contacts.readonly",immediate:!0},function(t){l.get("https://www.google.com/m8/feeds/contacts/default/full?alt=json&max-results=9999999",{params:gapi.auth.getToken()}).then(function(t){t&&t.data&&t.data.feed&&t.data.feed.entry&&angular.forEach(t.data.feed.entry,function(t){console.log(t),angular.forEach(t.gd$email,function(r){t.title.$t&&e.contacts.push({name:t.title.$t,email:r.address})})})})})},n.show({scope:e,title:"Invite user",contentUrl:"views/template/invite.html",ok:"Invite",onSubmit:function(t){var n=a.defer(),i=!1;return angular.forEach(e.users,function(t){t.email===e.invite.email&&(i=!0,a.all([r.join(["data/users",t.$id,"rosters"],"data/rosters").$link(d.$id),r.join(["data/rosters",d.$id,"participants"],"data/users").$link(t.$id),r.array("queues/email").$add({template:"added",data:{rosterId:d.$id,inviteeId:t.$id,inviterId:e.$me.$id}})]).then(function(){n.resolve(),o.showSimple('"'+t.name+'" added.')})["catch"](function(e){n.reject(e)}))}),i||(e.invite.name=(e.invite.name||"").replace(/\b\w+/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1)}),r.array("data/invites").$add(e.invite).then(function(e){c(e.key()).then(function(){n.resolve()})["catch"](function(e){n.reject(e)})})["catch"](function(e){n.reject(e)})),n.promise}})},e.resendInvite=function(e,t){(e||confirm("Are you sure you want to resend this user's invite?"))&&c(t)},e.rescindInvite=function(t,r,n){if(n=n||e.invites,t||confirm("Are you sure you want to rescind this user's invite?")){var i=r.name||r.email;n.$remove(r).then(function(){o.showSimple('Invite for "'+i+'" rescinded.')})}},e.isAdmin=function(e){return d&&angular.isObject(d.admins)&&d.admins[e]},e.toggleAdmin=function(t,r){var n=e.isAdmin(r.$id);if(t||confirm("Are you sure you want to "+(n?"demote this":"promote this participant to")+" roster admin?")){if(d.admins=d.admins||{},!n||n&&Object.keys(d.admins).length>1)return n=d.admins[r.$id]=d.admins[r.$id]?null:r.$id,d.$save().then(function(){o.showSimple('"'+r.name+'" is '+(n?"now":"no longer")+" a roster admin.")});o.showSimple("Sorry, you can't demote yourself since you are the only admin for this roster.")}}}]).controller("EventCtrl",["$scope","$firebaseHelper","$mdDialogForm","$state","$mdToast","Auth","RSVP","$location","API","$stateParams","Roster","Event",function(e,t,r,n,i,o,a,s,l,d,c,u){e.roster=c,e.event=u,void 0!==n.params.v&&o.$onAuth(function(t){t&&a(e.event).setParticipantStatus(t.uid,n.params.v).then(function(){s.url(s.path())})}),e.statuses=t.array("constants/statuses"),e.participants=t.join([c,"participants"],"data/users"),e.RSVP=a,e.urlencode=window.encodeURIComponent,e.deleteEvent=function(t){(t||confirm("Are you sure you want to permanently delete this event?"))&&e.event.$remove().then(function(){n.go("roster",{roster:c.$id}),i.showSimple("Event deleted.")})},e.editEvent=function(){e.event.$date=moment(e.event.date).toDate(),r.show({scope:e,title:"Edit event",contentUrl:"views/template/event.html",ok:"Save",onSubmit:function(t){return t.event.date=moment(t.event.$date).format(),e.event.$save().then(function(){i.showSimple("Event saved.")})}})},n.params.edit&&e.editEvent(),e.duplicateEvent=function(){var r={};return angular.forEach(e.event,function(e,t){switch(t){case"rsvps":case"hash":break;default:r[t]=e}}),t.array("data","rosters:events",c.$id).$add(r).then(function(e){n.go("event",{roster:c.$id,event:e.key(),edit:1}),i.showSimple("Event duplicated.")})}}]).controller("InviteCtrl",["$scope","$firebaseHelper","$state","$q","Auth","$mdToast","$mdDialog","Invite","Inviter","Roster",function(e,t,r,n,i,o,a,s,l,d){e.invite=s,e.inviter=l,e.roster=d,e.acceptInvite=function(){i.$auth()},i.$onAuth(function(t){return s.accepted?(o.showSimple("Invitation already accepted."),r.go("roster",s.rosterId)):void(t&&!e.notFound&&d.$loaded().then(function(){var n={};n[s.rosterId]=s.rosterId,e.$me.$ref().update({name:s.name||t.facebook.displayName,email:s.email||t.facebook.email,gender:(t.facebook.cachedUserProfile?t.facebook.cachedUserProfile.gender:!1)||"male",rosters:n}),d.invites&&delete d.invites[s.$id],d.participants||(d.participants={}),d.participants[t.uid]=t.uid,d.$save().then(function(){s.accepted=moment().format(),s.$save().then(function(){return o.showSimple("Invitation accepted."),r.go("roster",{roster:s.rosterId})})})}))})}]).controller("UserCtrl",["$scope","$firebaseHelper","$state","$mdToast","$mdDialogForm","User","$q",function(e,t,r,n,i,o,a){e.user=o,e.userRosters=t.join([o,"rosters"],"data/rosters"),e.editUser=function(){i.show({scope:e,title:"Edit user",contentUrl:"views/template/user.html",ok:"Save",onSubmit:function(){return o.$save().then(function(){n.showSimple("User saved.")})}})},e.newRoster=function(){e.roster={admins:{},participants:{}},e.roster.admins[e.$me.$id]=e.$me.$id,e.roster.participants[e.$me.$id]=e.$me.$id,i.show({scope:e,title:"Add new roster",contentUrl:"views/template/roster.html",ok:"Create",onSubmit:function(i){return e.myRosters.$add(i.roster).then(function(i){a.all([t.join([i,"admins"],"data/users").$link(e.$me.$id),t.join([i,"participants"],"data/users").$link(e.$me.$id),t.join([e.$me,"rosters"],"data/rosters").$link(i.key())]).then(function(){r.go("roster",{roster:i.key()}),n.showSimple("Roster created.")})})}})}}]).factory("RSVP",["$firebaseHelper","$q","$mdToast",function(e,t,r){return function(n,i){i=angular.extend({showToast:!0},i);var o=e.object("constants/statuses"),a=e.object(n,"rsvps");return{statuses:o,rsvps:a,getParticipantStatus:function(e){return a&&a[e]?a[e].status:-2},setParticipantStatus:function(n,s){s=parseInt(s),s=a&&a[n]&&a[n].status===s?-2:s;var l=t.defer();return e.ref(a,n).update({status:s,updated:moment().format()},function(){l.resolve(),i.showToast&&o.$loaded().then(function(){r.showSimple('Your RSVP saved as: "'+o[s].name+'"')})})}}}}]).directive("rsvp",function(){return{scope:{event:"=",participant:"=",readonly:"=?",mdSwipeItem:"=mdSwipeItemController"},restrict:"E",templateUrl:"views/directive/rsvp.html",controller:["$scope","RSVP",function(e,t){e.RSVP=t}]}}).directive("avatar",["$parse",function(e){return{scope:{roster:"="},restrict:"E",replace:!0,templateUrl:"views/directive/avatar.html",controller:["$scope","$element","$attrs",function(t,r,n){t.$size=parseInt(e(n.size)(t))||40,t.initials=function(e){return(e||"").split(" ").map(function(e){return e?e[0].toUpperCase():""}).join("")}}]}}]).directive("datetime",function(){return{scope:{date:"="},restrict:"E",replace:!0,templateUrl:"views/directive/datetime.html"}}).filter("filterByRsvp",function(){return function(e,t,r){return angular.isArray(e)?(angular.isObject(t)||(t={}),r=parseInt(r),e.filter(function(e){if(!t[e.$id])return-2===r;switch(t[e.$id].status){case 1:case 0:case-1:return r===t[e.$id].status;default:return-2===r}})):e}}).filter("filterByTimegroup",function(){return function(e,t){return angular.isArray(e)?e.filter(function(e){var r=moment().isSame(e.date,"day");return"today"===t?r:!r&&t===(moment().diff(e.date)<0?"upcoming":"past")}):e}}).filter("gender",function(){return function(e,t){return angular.isArray(e)&&angular.isString(t)?e.filter(function(e){return e.gender===t}):e}}).filter("length",function(){return function(e){return angular.isArray(e)?e.length:angular.isObject(e)?Object.keys(e).length:0}}).filter("concat",function(){return function(e,t){return e.concat(t)}}).factory("$mdDialogForm",["$mdDialog","$q",function(e,t){return{show:function(r){return e.show(e.confirm(angular.extend({focusOnOpen:!1,preserveScope:!0,ok:"Submit",cancel:"Cancel",template:['<md-dialog ng-form="dialogForm" md-theme="{{ dialog.theme }}" aria-label="{{ dialog.ariaLabel }}" ng-class="{loading: dialog.loading}">','<md-dialog-content role="document" tabIndex="-1">','<h2 class="md-title">{{ dialog.title }}</h2>','<p ng-if="dialog.content">{{ dialog.content }}</p>','<div ng-if="dialog.contentUrl" ng-include="dialog.contentUrl"></div>',"</md-dialog-content>",'<div class="md-actions">','<md-button ng-if="dialog.$type == \'confirm\'" ng-click="dialog.abort()" class="md-primary">',"{{ dialog.cancel }}","</md-button>",'<md-button type="submit" ng-disabled="dialogForm.$invalid || dialog.loading" ng-click="dialog.startLoading(); dialog.onSubmit(this).then(dialog.hide).finally(dialog.stopLoading)" class="md-primary">',"{{ dialog.ok }}","</md-button>","</div>","<md-dialog-footer>",'<md-progress-circular md-mode="indeterminate"></md-progress-circular>',"</md-dialog-footer>","</md-dialog>"].join(""),startLoading:function(){this.loading=!0},stopLoading:function(){this.loading=!1},onSubmit:function(e){var r=t.defer();return r.resolve(),r.promise}},r||{})))}}}]).factory("API",["$http","$q",function(e,t){var r="/api/v1/";return{post:function(n,i){var o=t.defer();return e.post(r+n.replace(/^\/+/,""),i.data,i).success(function(e){e&&e.success?o.resolve(e):o.reject(e)}).error(function(e,t){o.reject({code:t,message:e})}),o.promise}}}]).directive("loading",function(){return{restrict:"E",replace:!0,template:['<div flex layout="column" layout-align="center center">','<md-progress-circular md-mode="indeterminate"></md-progress-circular>',"</div>"].join("")}}).directive("mdSwipeItem",["$swipe","$timeout","$parse",function(e,t,r){return{restrict:"A",link:function(n,i,o){i.addClass("md-swipe-item");var a=angular.element(i.children()[0]),s=angular.element(i.children()[1]),l=angular.element(s.children()[0]),d=angular.element(s.children()[1]),c={left:!1,right:!1},u=!1,m=!1,f="ontouchend"in document,p=function(e){e===!0&&(e=0,c.left=c.right=!1,i.removeClass("md-swiping-left md-swiping-left-triggered md-swiping-right md-swiping-right-triggered"));var r="translate3d("+(e||0)+"px, 0, 0)";a.css({transform:r,webkitTransform:r}),i.addClass("md-swipe-item-animating"),t(function(){i.removeClass("md-swipe-item-animating"),c.leftMost&&i.removeClass("md-swiping-left-most-triggered"),c.rightMost&&i.removeClass("md-swiping-right-most-triggered"),c.left||i.removeClass("md-swiping-left md-swiping-left-triggered"),c.right||i.removeClass("md-swiping-right md-swiping-right-triggered")},100)},g=function(){return p(!0)};s.on("click",function(e){g()}),e.bind(a,{start:function(e){m=e},move:function(e){if(u=!0,m&&f&&r(o.mdSwipeItem)(n)){var t=e.x-m.x,l="translate3d("+t+"px, 0, 0)";a.css({transform:l,webkitTransform:l}),0>t?(i.addClass("md-swiping-left"),i.removeClass("md-swiping-right md-swiping-right-triggered"),c.right=!1,-72>t?(i.addClass("md-swiping-left-triggered"),c.left=!0):(i.removeClass("md-swiping-left-triggered"),c.left=!1),t<.75*-s[0].offsetWidth?(i.addClass("md-swiping-left-most-triggered"),c.leftMost=!0):(i.removeClass("md-swiping-left-most-triggered"),c.leftMost=!1)):(i.addClass("md-swiping-right"),i.removeClass("md-swiping-left md-swiping-left-triggered"),c.left=!1,t>72?(i.addClass("md-swiping-right-triggered"),c.right=!0):(i.removeClass("md-swiping-right-triggered"),c.right=!1),t>.75*s[0].offsetWidth?(i.addClass("md-swiping-right-most-triggered"),c.rightMost=!0):(i.removeClass("md-swiping-right-most-triggered"),c.rightMost=!1))}},end:function(){if(u){u=!1;var e="scale(1)";angular.forEach([l.children(),d.children()],function(t){angular.forEach(t,function(t){angular.element(t).css({transform:e,webkitTransform:e})})}),c.leftMost?r(o.mdSwipeLeftMostTriggered)(n):c.left?(r(o.mdSwipeLeftTriggered)(n),p(-172)):c.rightMost?r(o.mdSwipeRightMostTriggered)(n):c.right?r(o.mdSwipeRightTriggered)(n):g()}else g()},cancel:function(){u=!1,g()}}),n.mdSwipeItem={triggered:c,close:g,teaseLeft:function(){i.addClass("md-teasing-left"),t(function(){i.removeClass("md-teasing-left")},450)}}}}}]);